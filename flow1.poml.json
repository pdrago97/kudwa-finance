{
  "description": "Financial ontology RAG workflow",
  "version": "1.0",
  "process": {
    "input": {
      "type": "webhook",
      "method": "POST",
      "path": "9ba11544-5c4e-4f91-818a-08a4ecb596c5"
    },
    "output": {
      "type": "webhook_response"
    }
  },
  "steps": [
    {
      "id": "add_uuid",
      "type": "code",
      "description": "Generate UUID and attach to payload"
    },
    {
      "id": "extract_fields",
      "type": "set",
      "description": "Extract chatInput, sessionId, file flags"
    },
    {
      "id": "has_file_condition",
      "type": "condition",
      "condition": "{{ $json.hasFile }}",
      "true_branch": "process_file",
      "false_branch": "prepare_text_query"
    },
    {
      "id": "process_file",
      "type": "code",
      "description": "Decode file, parse JSON if possible, build enhanced prompt"
    },
    {
      "id": "prepare_text_query",
      "type": "set",
      "description": "Pass plain chatInput to LLM"
    },
    {
      "id": "vector_store",
      "type": "vector_store",
      "provider": "supabase",
      "topK": 8,
      "useReranker": true
    },
    {
      "id": "reranker",
      "type": "reranker",
      "provider": "cohere"
    },
    {
      "id": "llm",
      "type": "llm",
      "provider": "anthropic",
      "model": "claude-sonnet-4-20250514",
      "thinking": true
    },
    {
      "id": "output_parser",
      "type": "structured_output",
      "schema": {
        "type": "object",
        "properties": {
          "response": {"type": "string"},
          "response_type": {"type": "string", "enum": ["conversational", "ontology_proposal"]},
          "confidence_score": {"type": "number", "minimum": 0, "maximum": 1},
          "ontology_extensions": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "entity_type": {"type": "string"},
                "description": {"type": "string"},
                "justification": {"type": "string"},
                "confidence": {"type": "number"}
              },
              "required": ["entity_type", "description", "justification"]
            }
          },
          "data_entry_proposals": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "entity_type": {"type": "string"},
                "proposed_data": {"type": "object"},
                "confidence": {"type": "number"}
              },
              "required": ["entity_type", "proposed_data"]
            }
          }
        },
        "required": ["response", "response_type", "confidence_score"]
      }
    },
    {
      "id": "respond",
      "type": "webhook_response"
    }
  ],
  "connections": [
    {"from":"add_uuid","to":"extract_fields"},
    {"from":"extract_fields","to":"has_file_condition"},
    {"from":"has_file_condition","to":"process_file","when":"true"},
    {"from":"has_file_condition","to":"prepare_text_query","when":"false"},
    {"from":"process_file","to":"vector_store"},
    {"from":"prepare_text_query","to":"vector_store"},
    {"from":"vector_store","to":"reranker"},
    {"from":"reranker","to":"llm"},
    {"from":"llm","to":"output_parser"},
    {"from":"output_parser","to":"respond"}
  ]
}