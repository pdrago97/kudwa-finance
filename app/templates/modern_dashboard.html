<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kudwa Financial AI - Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', path='/css/modern-dashboard.css') }}" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://unpkg.com/cytoscape@3.26.0/dist/cytoscape.min.js"></script>
    <script src="https://unpkg.com/cytoscape-cose-bilkent@4.1.0/cytoscape-cose-bilkent.js"></script>
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo">
                <i class="fas fa-chart-line"></i>
                <span>Kudwa AI</span>
            </div>
            
            <nav>
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a href="#dashboard" class="nav-link active" data-section="dashboard">
                            <i class="fas fa-home"></i>
                            <span>Dashboard</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#chat" class="nav-link" data-section="chat">
                            <i class="fas fa-comments"></i>
                            <span>AI Chat</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#ontology" class="nav-link" data-section="ontology">
                            <i class="fas fa-project-diagram"></i>
                            <span>Ontology Classes</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#graph" class="nav-link" data-section="graph">
                            <i class="fas fa-share-alt"></i>
                            <span>Knowledge Graph</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#upload" class="nav-link" data-section="upload">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <span>File Upload</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#documents" class="nav-link" data-section="documents">
                            <i class="fas fa-file-alt"></i>
                            <span>Documents</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#approvals" class="nav-link" data-section="approvals">
                            <i class="fas fa-check-circle"></i>
                            <span>Approvals</span>
                            <span class="approval-count badge" id="approval-count">0</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#settings" class="nav-link" data-section="settings">
                            <i class="fas fa-cog"></i>
                            <span>Settings</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </aside>

        <!-- Main Header -->
        <header class="main-header">
            <div class="flex items-center gap-4">
                <h1 id="page-title">Financial Dashboard</h1>
            </div>
            <div class="flex items-center gap-4">
                <button class="btn btn-danger btn-sm" id="wipe-database-btn">
                    <i class="fas fa-trash"></i>
                    Wipe Database
                </button>
                <button class="btn btn-primary btn-sm" id="refresh-data-btn">
                    <i class="fas fa-sync-alt"></i>
                    Refresh
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Dashboard Section -->
            <section id="dashboard-section" class="content-section">
                <!-- Dashboard Header -->
                <div class="dashboard-header">
                    <h2>Financial Dashboard</h2>
                    <div class="dashboard-actions">
                        <button class="btn btn-primary" id="add-widget-btn">
                            <i class="fas fa-plus"></i>
                            Add Widget
                        </button>
                    </div>
                </div>

                <!-- Stats Grid -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="total-documents">0</div>
                        <div class="stat-label">Documents</div>
                        <div class="stat-change positive">+0 this month</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="total-ontology-classes">0</div>
                        <div class="stat-label">Ontology Classes</div>
                        <div class="stat-change positive">+0 this month</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="total-observations">0</div>
                        <div class="stat-label">Financial Observations</div>
                        <div class="stat-change positive">+0 this month</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="total-datasets">0</div>
                        <div class="stat-label">Datasets</div>
                        <div class="stat-change positive">+0 this month</div>
                    </div>
                </div>

                <!-- Widget Canvas -->
                <div class="widget-canvas" id="widget-canvas">
                    <!-- Default widgets will be loaded here -->
                    <div class="widget-placeholder" id="widget-placeholder">
                        <div class="placeholder-content">
                            <i class="fas fa-plus-circle"></i>
                            <h3>Add Your First Widget</h3>
                            <p>Click "Add Widget" to create custom visualizations, tables, or analytics based on your data.</p>
                            <button class="btn btn-primary" onclick="document.getElementById('add-widget-btn').click()">
                                <i class="fas fa-plus"></i>
                                Get Started
                            </button>
                        </div>
                    </div>
                </div>


            </section>

            <!-- Chat Section -->
            <section id="chat-section" class="content-section hidden">
                <div class="chat-container">
                    <div class="chat-header">
                        <h3>AI Financial Assistant</h3>
                        <p class="text-secondary">Ask questions about your financial data or upload documents</p>
                    </div>
                    
                    <div class="chat-messages" id="chat-messages">
                        <div class="message">
                            <div class="message-avatar">AI</div>
                            <div class="message-content">
                                <div class="welcome-message">
                                    <h4>üß† Welcome to Kudwa Financial AI with Agno Integration!</h4>
                                    <p>I'm your enhanced AI assistant powered by both <strong>Agno reasoning</strong> and <strong>CrewAI</strong>. I can help you with:</p>

                                    <div class="capabilities-grid">
                                        <div class="capability-item">
                                            <strong>üìä Financial Analysis</strong><br>
                                            Deep analysis of your financial data with step-by-step reasoning
                                        </div>
                                        <div class="capability-item">
                                            <strong>üìÑ Document Processing</strong><br>
                                            Upload documents for intelligent extraction and analysis
                                        </div>
                                        <div class="capability-item">
                                            <strong>üîç Ontology Management</strong><br>
                                            Manage and extend your financial ontology
                                        </div>
                                        <div class="capability-item">
                                            <strong>üé® Interface Creation</strong><br>
                                            Generate custom interfaces and visualizations
                                        </div>
                                    </div>

                                    <div class="agno-commands">
                                        <h5>üöÄ Quick Commands:</h5>
                                        <div class="command-list">
                                            <code>/reasoning on</code> - Enable detailed step-by-step analysis<br>
                                            <code>/demo</code> - See Agno reasoning in action<br>
                                            <code>/interface</code> - Create custom interfaces<br>
                                            <code>/agno-status</code> - Check system status<br>
                                            <code>/upload</code> - Upload documents
                                        </div>
                                    </div>

                                    <p><strong>Try asking:</strong> "Analyze my revenue trends with reasoning" or "Create a dashboard for expenses"</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="chat-input-container">
                        <div class="chat-input-wrapper">
                            <button class="btn btn-secondary file-upload-btn" id="file-upload-btn">
                                <i class="fas fa-paperclip"></i>
                                <input type="file" class="file-upload-input" id="file-upload-input" 
                                       accept=".json,.pdf,.csv,.xlsx,.txt" multiple>
                            </button>
                            <textarea class="chat-input" id="chat-input" 
                                    placeholder="Ask about your financial data or upload documents..."
                                    rows="1"></textarea>
                            <button class="btn btn-primary" id="send-message-btn">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                        <div id="file-preview" class="file-preview hidden"></div>
                    </div>
                </div>
            </section>

            <!-- Ontology Section -->
            <section id="ontology-section" class="content-section hidden">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Ontology Classes</h3>
                        <button class="btn btn-primary btn-sm" id="refresh-ontology-btn">
                            <i class="fas fa-sync-alt"></i>
                            Refresh
                        </button>
                    </div>
                    <div class="card-content">
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Class ID</th>
                                        <th>Label</th>
                                        <th>Type</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="ontology-classes">
                                    <tr>
                                        <td colspan="5" class="text-center">Loading...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- File Upload Section -->
            <section id="upload-section" class="content-section hidden">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Document Upload & Processing</h3>
                        <div class="flex items-center gap-4">
                            <button class="btn btn-secondary btn-sm" id="clear-upload-history-btn">
                                <i class="fas fa-trash"></i>
                                Clear History
                            </button>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="upload-area">
                            <!-- Pipeline Configuration -->
                            <div class="pipeline-config-section">
                                <h4>üîß Processing Pipeline Configuration</h4>
                                <div class="pipeline-options">
                                    <div class="pipeline-option">
                                        <input type="radio" id="langextract-pipeline" name="pipeline" value="langextract" checked>
                                        <label for="langextract-pipeline">
                                            <div class="pipeline-card">
                                                <div class="pipeline-icon">üß†</div>
                                                <div class="pipeline-info">
                                                    <h5>LangExtract</h5>
                                                    <p>Google's advanced entity extraction and ontology mapping</p>
                                                    <div class="pipeline-features">
                                                        <span class="feature-tag">Entity Recognition</span>
                                                        <span class="feature-tag">Ontology Mapping</span>
                                                        <span class="feature-tag">Confidence Scoring</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </label>
                                    </div>

                                    <div class="pipeline-option">
                                        <input type="radio" id="rag-anything-pipeline" name="pipeline" value="rag-anything">
                                        <label for="rag-anything-pipeline">
                                            <div class="pipeline-card">
                                                <div class="pipeline-icon">üîç</div>
                                                <div class="pipeline-info">
                                                    <h5>RAG-Anything</h5>
                                                    <p>Advanced RAG system for any data type and pattern</p>
                                                    <div class="pipeline-features">
                                                        <span class="feature-tag">Multi-Modal RAG</span>
                                                        <span class="feature-tag">Pattern Recognition</span>
                                                        <span class="feature-tag">Context Retrieval</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </label>
                                    </div>

                                    <div class="pipeline-option">
                                        <input type="radio" id="agno-pipeline" name="pipeline" value="agno">
                                        <label for="agno-pipeline">
                                            <div class="pipeline-card">
                                                <div class="pipeline-icon">‚ö°</div>
                                                <div class="pipeline-info">
                                                    <h5>Agno AGI</h5>
                                                    <p>Reasoning-based document analysis with step-by-step insights</p>
                                                    <div class="pipeline-features">
                                                        <span class="feature-tag">Reasoning Engine</span>
                                                        <span class="feature-tag">Multi-Step Analysis</span>
                                                        <span class="feature-tag">Insight Generation</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </label>
                                    </div>

                                    <div class="pipeline-option">
                                        <input type="radio" id="hybrid-pipeline" name="pipeline" value="hybrid">
                                        <label for="hybrid-pipeline">
                                            <div class="pipeline-card">
                                                <div class="pipeline-icon">üöÄ</div>
                                                <div class="pipeline-info">
                                                    <h5>Hybrid Pipeline</h5>
                                                    <p>Combines multiple tools for maximum accuracy and insights</p>
                                                    <div class="pipeline-features">
                                                        <span class="feature-tag">Multi-Tool</span>
                                                        <span class="feature-tag">Cross-Validation</span>
                                                        <span class="feature-tag">Best Results</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <div class="upload-zone" id="upload-zone">
                                <div class="upload-zone-content">
                                    <i class="fas fa-cloud-upload-alt upload-icon"></i>
                                    <h4>Drop files here or click to browse</h4>
                                    <p>Supports JSON, CSV, PDF, Excel, and text files</p>
                                    <p class="text-muted">Files will be processed with selected pipeline</p>
                                    <input type="file" id="dedicated-file-input" style="display: none;"
                                           accept=".json,.csv,.pdf,.xlsx,.txt,.xls" multiple>
                                    <button class="btn btn-primary" onclick="document.getElementById('dedicated-file-input').click()">
                                        <i class="fas fa-folder-open"></i>
                                        Choose Files
                                    </button>
                                </div>
                            </div>

                            <div id="upload-progress-section" class="upload-progress-section hidden">
                                <div class="progress-container">
                                    <div class="progress">
                                        <div class="progress-bar" id="upload-progress-bar" role="progressbar" style="width: 0%"></div>
                                    </div>
                                    <p class="upload-status" id="upload-status">Processing...</p>
                                </div>
                            </div>

                            <!-- Interactive Processing Chat -->
                            <div id="interactive-processing-section" class="interactive-processing-section hidden">
                                <div class="processing-chat-container">
                                    <div class="processing-chat-header">
                                        <h4>ü§ñ Interactive Processing Assistant</h4>
                                        <div class="processing-status">
                                            <span id="processing-stage">Initializing...</span>
                                            <div class="processing-progress">
                                                <div class="progress-bar" id="processing-progress-bar"></div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="processing-chat-messages" id="processing-chat-messages">
                                        <!-- Messages will be added here -->
                                    </div>

                                    <div class="processing-chat-input">
                                        <div class="chat-input-container">
                                            <input type="text" id="processing-chat-input" placeholder="Guide the processing, ask questions, or provide feedback..." disabled>
                                            <button id="processing-chat-send" class="btn btn-primary" disabled>
                                                <i class="fas fa-paper-plane"></i>
                                            </button>
                                        </div>
                                        <div class="quick-actions">
                                            <button class="quick-action-btn" data-action="approve">‚úÖ Approve Step</button>
                                            <button class="quick-action-btn" data-action="modify">üîß Suggest Modification</button>
                                            <button class="quick-action-btn" data-action="question">‚ùì Ask Question</button>
                                            <button class="quick-action-btn" data-action="skip">‚è≠Ô∏è Skip Step</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div id="upload-results-section" class="upload-results-section">
                                <h5>Recent Uploads</h5>
                                <div id="upload-results-list" class="upload-results-list">
                                    <p class="text-muted">No files uploaded yet</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Knowledge Graph Section -->
            <section id="graph-section" class="content-section hidden">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Knowledge Graph</h3>
                        <div class="flex items-center gap-4">
                            <select id="graph-layout-select" class="form-select">
                                <option value="cose-bilkent">Hierarchical</option>
                                <option value="circle">Circle</option>
                                <option value="grid">Grid</option>
                                <option value="breadthfirst">Tree</option>
                            </select>
                            <button class="btn btn-secondary btn-sm" id="fit-graph-btn">
                                <i class="fas fa-expand-arrows-alt"></i>
                                Fit
                            </button>
                            <button class="btn btn-primary btn-sm" id="refresh-graph-btn">
                                <i class="fas fa-sync-alt"></i>
                                Refresh
                            </button>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="graph-container">
                            <div id="knowledge-graph" style="height: 600px; width: 100%; border: 1px solid var(--border); border-radius: var(--radius);"></div>
                        </div>
                        <div class="graph-controls mt-4">
                            <div class="flex items-center gap-4">
                                <div class="graph-legend">
                                    <div class="legend-item">
                                        <div class="legend-color" style="background: #2563eb;"></div>
                                        <span>Ontology Classes</span>
                                    </div>
                                    <div class="legend-item">
                                        <div class="legend-color" style="background: #10b981;"></div>
                                        <span>Financial Entities</span>
                                    </div>
                                    <div class="legend-item">
                                        <div class="legend-color" style="background: #f59e0b;"></div>
                                        <span>Documents</span>
                                    </div>
                                    <div class="legend-item">
                                        <div class="legend-color" style="background: #ef4444;"></div>
                                        <span>Relationships</span>
                                    </div>
                                </div>
                                <div class="graph-stats">
                                    <span id="graph-node-count">0 nodes</span>
                                    <span id="graph-edge-count">0 edges</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Documents Section -->
            <section id="documents-section" class="content-section hidden">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Documents</h3>
                        <button class="btn btn-primary btn-sm" id="upload-document-btn">
                            <i class="fas fa-upload"></i>
                            Upload Document
                        </button>
                    </div>
                    <div class="card-content">
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Filename</th>
                                        <th>Type</th>
                                        <th>Size</th>
                                        <th>Status</th>
                                        <th>Uploaded</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="documents-list">
                                    <tr>
                                        <td colspan="6" class="text-center">Loading...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Approvals Section -->
            <section id="approvals-section" class="content-section hidden">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Pending Approvals</h3>
                        <div class="card-header-actions">
                            <button id="bulk-approve-btn" class="btn btn-success" style="display: none;" onclick="bulkApproveAll()">
                                <i class="fas fa-check-double"></i> Approve All
                            </button>
                            <span class="badge" id="pending-count">0 pending</span>
                        </div>
                    </div>
                    <div class="card-content">
                        <div id="approval-items">
                            <p class="text-center text-secondary">No pending approvals</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Node Details Modal -->
            <div id="nodeModal" class="modal" style="display: none;">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 id="modalTitle">Node Details</h3>
                        <span class="modal-close">&times;</span>
                    </div>
                    <div class="modal-body">
                        <div id="nodeDetails" class="node-details"></div>

                        <!-- Record-specific chatbot -->
                        <div class="record-chat-section">
                            <h4>Ask about this record</h4>
                            <div id="recordChatMessages" class="record-chat-messages"></div>
                            <div class="record-chat-input">
                                <input type="text" id="recordChatInput" placeholder="Ask a question about this specific record..." />
                                <button id="recordChatSend">Send</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Widget Creation Modal -->
            <div id="widgetModal" class="modal" style="display: none;">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Create Custom Widget</h3>
                        <span class="modal-close">&times;</span>
                    </div>
                    <div class="modal-body">
                        <div class="widget-creation-form">
                            <h4>What would you like to visualize?</h4>
                            <p class="text-secondary">Describe what you want to see and our AI will create a custom widget for you.</p>

                            <div class="form-group">
                                <label for="widgetPrompt">Widget Description</label>
                                <textarea id="widgetPrompt" placeholder="Examples:
‚Ä¢ Show me a table of all revenue streams
‚Ä¢ Create a pie chart of expense categories
‚Ä¢ Display the top 5 accounts by amount
‚Ä¢ Show a timeline of financial observations
‚Ä¢ Create a KPI card for total revenue
‚Ä¢ Build a real-time expense tracker
‚Ä¢ Show me a graph of monthly trends"></textarea>
                            </div>

                            <div class="form-group">
                                <label for="widgetSize">Widget Size</label>
                                <select id="widgetSize">
                                    <option value="quarter">Quarter (1/4 screen)</option>
                                    <option value="half" selected>Half (1/2 screen)</option>
                                    <option value="full">Full (1/1 screen)</option>
                                </select>
                            </div>

                            <div class="widget-examples">
                                <h5>Quick Templates:</h5>
                                <div class="example-buttons">
                                    <button class="btn btn-outline" onclick="setWidgetExample('revenue-chart')">
                                        <i class="fas fa-chart-line"></i> Revenue Chart
                                    </button>
                                    <button class="btn btn-outline" onclick="setWidgetExample('expense-table')">
                                        <i class="fas fa-table"></i> Expense Table
                                    </button>
                                    <button class="btn btn-outline" onclick="setWidgetExample('kpi-cards')">
                                        <i class="fas fa-tachometer-alt"></i> KPI Dashboard
                                    </button>
                                    <button class="btn btn-outline" onclick="setWidgetExample('live-feed')">
                                        <i class="fas fa-stream"></i> Live Data Feed
                                    </button>
                                    <button class="btn btn-outline" onclick="setWidgetExample('ontology-explorer')">
                                        <i class="fas fa-project-diagram"></i> Ontology Explorer
                                    </button>
                                    <button class="btn btn-outline" onclick="setWidgetExample('document-tracker')">
                                        <i class="fas fa-file-alt"></i> Document Tracker
                                    </button>
                                </div>
                            </div>

                            <div class="modal-actions">
                                <button class="btn btn-secondary" onclick="closeWidgetModal()">Cancel</button>
                                <button class="btn btn-primary" id="createWidgetBtn">
                                    <i class="fas fa-magic"></i>
                                    Create Widget
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Section -->
            <section id="settings-section" class="content-section hidden">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">System Settings</h3>
                    </div>
                    <div class="card-content">
                        <div class="settings-grid">
                            <div class="setting-item">
                                <h4>Database Management</h4>
                                <p class="text-secondary">Manage your database and data</p>
                                <div class="mt-4">
                                    <button class="btn btn-danger" id="confirm-wipe-btn">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        Wipe All Data
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Modals -->
    <div id="wipe-confirmation-modal" class="modal hidden">
        <div class="modal-content">
            <h3>Confirm Database Wipe</h3>
            <p>This will permanently delete all data including documents, ontology classes, and financial observations. This action cannot be undone.</p>
            <div class="modal-actions">
                <button class="btn btn-secondary" id="cancel-wipe-btn">Cancel</button>
                <button class="btn btn-danger" id="execute-wipe-btn">
                    <i class="fas fa-trash"></i>
                    Wipe Database
                </button>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', path='/js/modern-dashboard.js') }}"></script>
    <script src="{{ url_for('static', path='/js/agno-chat.js') }}"></script>
</body>
</html>
